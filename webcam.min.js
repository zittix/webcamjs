!function(a){function k(){var a=Error.apply(this,arguments);a.name=this.name="FlashError",this.stack=a.stack,this.message=a.message}function l(){var a=Error.apply(this,arguments);a.name=this.name="WebcamError",this.stack=a.stack,this.message=a.message}function n(a,b){var c=b.canvas,d=c.width/a.width,e=c.height/a.height,f=Math.min(d,e),g=(c.width-a.width*f)/2,h=(c.height-a.height*f)/2;b.clearRect(0,0,c.width,c.height),b.drawImage(a,0,0,a.width,a.height,g,h,a.width*f,a.height*f)}function o(a){var b=a.target.files[0];if(console.log("image input"),b){var c=this,d=new FileReader;d.onload=function(a){c.dispatch("imageSelected",a.target.result)},d.readAsDataURL(b)}}function p(a){return a.charAt(0).toUpperCase()+a.slice(1)}function q(a,b,c){var d=["o","ms","moz","webkit"];d.forEach(function(d){a.style[d+p(b)]=c}),a.style[b]=c}var b,c=a.location,d=c&&c.protocol.match(/https/i)?"https":"http",e="webcam_movie_embed",f="webcam_movie_obj",g=a.URL||a.webkitURL||a.mozURL||a.msURL,h=a.localStorage,i=a.navigator,j=!!a.addEventListener;IntermediateInheritor=function(){},IntermediateInheritor.prototype=Error.prototype,k.prototype=new IntermediateInheritor,l.prototype=new IntermediateInheritor;var m={version:"1.0.10",loaded:!1,live:!1,userMedia:!0,params:{width:0,height:0,dest_width:0,dest_height:0,image_format:"jpeg",jpeg_quality:90,force_flash:!1,force_file:!1,flip_horiz:!1,fps:30,upload_name:"webcam",constraints:null,swfURL:"",flashNotDetectedText:"ERROR: No Adobe Flash Player detected.  Webcam.js relies on Flash for browsers that do not support getUserMedia (like yours).",enable_file_fallback:!0,css_prefix:"webcamjs",unfreeze_snap:!0},errors:{FlashError:k,WebcamError:l},hooks:{},init:function(){var a=this;this.mediaDevices=i.mediaDevices&&i.mediaDevices.getUserMedia?i.mediaDevices:i.mozGetUserMedia||i.webkitGetUserMedia?{getUserMedia:function(a){return new Promise(function(b,c){(i.mozGetUserMedia||i.webkitGetUserMedia).call(i,a,b,c)})}}:null,this.userMedia=this.userMedia&&!!this.mediaDevices&&!!g,i.userAgent.match(/Firefox\D+(\d+)/)&&parseInt(RegExp.$1,10)<21&&(this.userMedia=null),this.userMedia&&addEventListener("beforeunload",function(b){a.reset()})},attach:function(c){if("string"==typeof c&&(c=document.getElementById(c)||document.querySelector(c)),!c)return this.dispatch("error",new l("Could not locate DOM element to attach to."));this.container=c,c.innerHTML="";var d=document.createElement("div");if(d.className=this.params.css_prefix+"__peg",c.appendChild(d),this.peg=d,this.params.width||(this.params.width=c.offsetWidth),this.params.height||(this.params.height=c.offsetHeight),!this.params.width||!this.params.height)return this.dispatch("error",new l("No width and/or height for webcam.  Please call set() first, or attach to a visible element."));this.params.dest_width||(this.params.dest_width=this.params.width),this.params.dest_height||(this.params.dest_height=this.params.height),this.userMedia=void 0===b?this.userMedia:b,(this.params.force_flash||this.params.force_file)&&(b=this.userMedia,this.userMedia=null),"number"!=typeof this.params.fps&&(this.params.fps=30);var e=this.params.width/this.params.dest_width,f=this.params.height/this.params.dest_height;if(this.userMedia){var h=document.createElement("video");h.className=this.params.css_prefix+"__video",h.setAttribute("autoplay","autoplay"),h.style.width=this.params.dest_width+"px",h.style.height=this.params.dest_height+"px",1==e&&1==f||(c.style.overflow="hidden",q(h,"transformOrigin","0px 0px"),q(h,"transform","scaleX("+e+") scaleY("+f+")")),c.appendChild(h),this.video=h;var i=this;this.mediaDevices.getUserMedia({audio:!1,video:this.params.constraints||{mandatory:{minWidth:this.params.dest_width,minHeight:this.params.dest_height}}}).then(function(a){h.onloadedmetadata=function(b){i.stream=a,i.loaded=!0,i.live=!0,i.dispatch("load"),i.dispatch("live"),i.flip()},h.src=g.createObjectURL(a)||a},function(a){return i.dispatch("error",a)})}else if(!this.detectFlash()&&this.params.enable_file_fallback)c.appendChild(this.getUploadFallbackNode()),this.loaded=!0;else{a.Webcam=m;var j=document.createElement("div");j.className=this.params.css_prefix+"__flash-container",j.innerHTML=this.getSWFHTML(),c.appendChild(j)}if(this.params.crop_width&&this.params.crop_height){var k=Math.floor(this.params.crop_width*e),n=Math.floor(this.params.crop_height*f);c.style.width=k+"px",c.style.height=n+"px",c.style.overflow="hidden",c.scrollLeft=Math.floor(this.params.width/2-k/2),c.scrollTop=Math.floor(this.params.height/2-n/2)}else c.style.width=this.params.width+"px",c.style.height=this.params.height+"px"},reset:function(){try{if(this.preview_active&&this.unfreeze(),this.unflip(),this.userMedia){if(this.stream)if(this.stream.getVideoTracks){var a=this.stream.getVideoTracks();a&&a[0]&&a[0].stop&&a[0].stop()}else this.stream.stop&&this.stream.stop();delete this.stream,delete this.video}!this.userMedia&&this.detectFlash()&&this.getMovie()._releaseCamera()}catch(a){this.dispatch("error","Could not reset webcam: "+a,a)}this.container&&(this.container.innerHTML="",delete this.container),this.loaded=!1,this.live=!1,delete this.fallbackImage},set:function(){if(1==arguments.length)for(var a in arguments[0])this.params[a]=arguments[0][a];else this.params[arguments[0]]=arguments[1]},on:function(a,b){a=a.toLowerCase().replace(/^on/,""),this.hooks[a]||(this.hooks[a]=[]),this.hooks[a].push(b)},off:function(a,b){if(a=a.toLowerCase().replace(/^on/,""),this.hooks[a])if(b){var c=this.hooks[a].indexOf(b);c>-1&&this.hooks[a].splice(c,1)}else this.hooks[a]=[]},dispatch:function(){var b=arguments[0].toLowerCase().replace(/^on/,""),c=Array.prototype.slice.call(arguments,1);if(this.hooks[b]&&this.hooks[b].length){for(var d=0,e=this.hooks[b].length;d<e;d++){var f=this.hooks[b][d];"function"==typeof f?f.apply(this,c):"object"==typeof f&&2==f.length?f[0][f[1]].apply(f[0],c):a[f]&&a[f].apply(a,c)}return!0}return"error"==b&&(c[0]instanceof k||c[0]instanceof l?message=c[0].message:message="Could not access webcam: "+c[0].name+": "+c[0].message+" "+c[0].toString(),alert("Webcam.js Error: "+message)),!1},setSWFLocation:function(a){this.set("swfURL",a)},detectFlash:function(){if(this.params.force_file||null===this.params.swfURL)return!1;var a="Shockwave Flash",b="ShockwaveFlash.ShockwaveFlash",c="application/x-shockwave-flash",d=!1;if(void 0!==i.plugins&&"object"==typeof i.plugins[a]){var e=i.plugins[a].description;e&&void 0!==i.mimeTypes&&i.mimeTypes[c]&&i.mimeTypes[c].enabledPlugin&&(d=!0)}else if("undefined"!=typeof ActiveXObject)try{var f=new ActiveXObject(b);if(f){var g=f.GetVariable("$version");g&&(d=!0)}}catch(a){}return d},getUploadFallbackNode:function(){var a=document.createElement("input");a.type="file",a.accept="image/*",a.setAttribute("capture","camera"),a.id="imageLoader",a.name="imageLoader",this.fallbackNodeInput=a;var b=document.createElement("div");return b.className=this.params.css_prefix+"__upload-fallback",b.appendChild(a),a.addEventListener("change",o.bind(this),!1),b},getSWFHTML:function(){var a="",b=this.params.swfURL;if(d.match(/file/))return this.dispatch("error",new k("Flash does not work from local disk.  Please run from a web server.")),'<h3 class="'+this.params.css_prefix+'__error">ERROR: the Webcam.js Flash fallback does not work from local disk.  Please run it from a web server.</h3>';if(!this.detectFlash())return this.dispatch("error",new k("Adobe Flash Player not found.  Please install from get.adobe.com/flashplayer and try again.")),'<h3 class="'+this.params.css_prefix+'__error">'+this.params.flashNotDetectedText+"</h3>";if(""===b){for(var c="",g=document.getElementsByTagName("script"),i=0,j=g.length;i<j;i++){var l=g[i].getAttribute("src");l&&l.match(/\/webcam(\.min)?\.js/)&&(c=l.replace(/\/webcam(\.min)?\.js.*$/,""),i=j)}b="webcam.swf",c&&(b=c+"/"+b)}if(h&&!h.getItem("webcamjs_visited")){this.params.new_user=1;try{h.setItem("webcamjs_visited",1)}catch(a){}}var m="";for(var n in this.params)m&&(m+="&"),m+=n+"="+escape(this.params[n]);return a+='<object class="'+this.params.css_prefix+'__flash" classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" type="application/x-shockwave-flash" codebase="'+d+'://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" width="'+this.params.width+'" height="'+this.params.height+'" id="'+f+'" align="middle"><param name="wmode" value="opaque" /><param name="allowScriptAccess" value="always" /><param name="allowFullScreen" value="false" /><param name="movie" value="'+b+'" /><param name="loop" value="false" /><param name="menu" value="false" /><param name="quality" value="best" /><param name="bgcolor" value="#ffffff" /><param name="flashvars" value="'+m+'"/><embed id="'+e+'" src="'+b+'" wmode="opaque" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="'+this.params.width+'" height="'+this.params.height+'" name="'+e+'" align="middle" allowScriptAccess="always" allowFullScreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="'+m+'"></embed></object>'},getMovie:function(){if(!this.loaded)return this.dispatch("error",new k("Flash Movie is not loaded yet"));var a=document.getElementById(f);return a&&a._snap||(a=document.getElementById(e)),a||this.dispatch("error",new k("Cannot locate Flash movie in DOM")),a},freeze:function(){var a=this,b=this.params;this.preview_active&&this.unfreeze();var c=this.params.width/this.params.dest_width,d=this.params.height/this.params.dest_height;this.unflip();var e=b.crop_width||b.dest_width,f=b.crop_height||b.dest_height,g=document.createElement("canvas");g.className=this.params.css_prefix+"__preview",g.width=e,g.height=f;var h=g.getContext("2d");this.preview_canvas=g,this.preview_context=h,1==c&&1==d||(q(g,"transformOrigin","0px 0px"),q(g,"transform","scaleX("+c+") scaleY("+d+")")),this.snap(function(){g.style.position="relative",g.style.left=a.container.scrollLeft+"px",g.style.top=a.container.scrollTop+"px",a.container.insertBefore(g,a.peg),a.container.style.overflow="hidden",a.preview_active=!0},g)},unfreeze:function(){this.preview_active&&(this.container.removeChild(this.preview_canvas),delete this.preview_context,delete this.preview_canvas,this.preview_active=!1,this.flip())},flip:function(){this.params.flip_horiz&&(q(this.container,"transform","scaleX(-1)"),this.container.style.filter="FlipH",this.container.style.msFilter="FlipH")},unflip:function(){this.params.flip_horiz&&(q(this.container,"transform","scaleX(1)"),this.container.style.filter="",this.container.style.msFilter="")},savePreview:function(a,b){var c=this.params,d=this.preview_canvas,e=this.preview_context;if(b){var f=b.getContext("2d");f.drawImage(d,0,0)}a(b?null:d.toDataURL("image/"+c.image_format,c.jpeg_quality/100),d,e),this.params.unfreeze_snap&&this.unfreeze()},snap:function(a,b){var c=this.params;if(!this.loaded)return this.dispatch("error",new l("Webcam is not loaded yet"));if(!a)return this.dispatch("error",new l("Please provide a callback function or canvas to snap()"));if(this.preview_active)return this.savePreview(a,b),null;var d=document.createElement("canvas");d.width=this.params.dest_width,d.height=this.params.dest_height;var e=d.getContext("2d");this.params.flip_horiz&&(e.translate(c.dest_width,0),e.scale(-1,1));var f=function(){if(this.src&&this.width&&this.height&&e.drawImage(this,0,0,c.dest_width,c.dest_height),c.crop_width&&c.crop_height){var f=document.createElement("canvas");f.width=c.crop_width,f.height=c.crop_height;var g=f.getContext("2d");g.drawImage(d,Math.floor(c.dest_width/2-c.crop_width/2),Math.floor(c.dest_height/2-c.crop_height/2),c.crop_width,c.crop_height,0,0,c.crop_width,c.crop_height),e=g,d=f}if(b){var h=b.getContext("2d");h.drawImage(d,0,0)}a(b?null:d.toDataURL("image/"+c.image_format,c.jpeg_quality/100),d,e)};if(this.userMedia)e.drawImage(this.video,0,0,this.params.dest_width,this.params.dest_height),f();else if(this.detectFlash()){var g=this.getMovie()._snap(),h=new Image;h.onload=f,h.src="data:image/"+this.params.image_format+";base64,"+g}else{if(!this.params.enable_file_fallback)return this.loaded?this.dispatch("error","Webcam has encountered an unknown error."):this.dispatch("error","Webcam is not loaded yet");if(this.fallbackImage)n(this.fallbackImage.data,e),f();else{if(!this.fallbackNodeInput)return this.dispatch("error","Select picture first.");this.fallbackNodeInput.click()}}return null},configure:function(a){a||(a="camera"),this.getMovie()._configure(a)},flashNotify:function(a,b){switch(a){case"flashLoadComplete":this.loaded=!0,this.dispatch("load");break;case"cameraLive":this.live=!0,this.dispatch("live");break;case"error":this.dispatch("error",new k(b))}},b64ToUint6:function(a){return a>64&&a<91?a-65:a>96&&a<123?a-71:a>47&&a<58?a+4:43===a?62:47===a?63:0},base64DecToArr:function(a,b){for(var g,h,c=a.replace(/[^A-Za-z0-9\+\/]/g,""),d=c.length,e=b?Math.ceil((3*d+1>>2)/b)*b:3*d+1>>2,f=new Uint8Array(e),i=0,j=0,k=0;k<d;k++)if(h=3&k,i|=this.b64ToUint6(c.charCodeAt(k))<<18-6*h,3===h||d-k===1){for(g=0;g<3&&j<e;g++,j++)f[j]=i>>>(16>>>g&24)&255;i=0}return f},upload:function(a,b,c){var d=this.params.upload_name||"webcam",e="";if(!a.match(/^data\:image\/(\w+)/))throw"Cannot locate image format in Data URI";e=RegExp.$1;var f=a.replace(/^data\:image\/\w+\;base64\,/,""),g=new XMLHttpRequest;g.open("POST",b,!0),g.upload&&g.upload.addEventListener&&g.upload.addEventListener("progress",function(a){if(a.lengthComputable){var b=a.loaded/a.total;m.dispatch("uploadProgress",b,a)}},!1);var h=this;g.onload=function(){c&&c.apply(h,[g.status,g.responseText,g.statusText]),m.dispatch("uploadComplete",g.status,g.responseText,g.statusText)};var i=new Blob([this.base64DecToArr(f)],{type:"image/"+e}),j=new FormData;return j.append(d,i,d+"."+e.replace(/e/,"")),g.send(j),g}};j&&m.init(),"function"==typeof define&&define.amd?define(function(){return m}):"object"==typeof module&&module.exports?module.exports=m:a.Webcam=m}("undefined"==typeof window?{}:window);